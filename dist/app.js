
!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="c6c04eac-69ac-546e-854e-70c435e24b79")}catch(e){}}();
import h from"express";import D from"helmet";import{verifySignature as S}from"@vonage/jwt";import v from"sanitize-html";import{URL as E}from"node:url";import M from"node:fs/promises";import*as n from"@sentry/node";import{Vonage as T}from"@vonage/server-sdk";import{Channels as x}from"@vonage/messages";function y(t){let e=t.headers.authorization.split(" ")[1];if(!e)throw new Error("No signature");if(!S(e,process.env.VONAGE_SIGNATURE_SECRET))throw new Error("Invalid signature")}function b(t){let e=t.replace(/\s+/g," ");return e=e.trim(),e=v(e,{allowedTags:[],allowedAttributes:{}}),e}async function _(t,e,r){try{if(!new E(t).hostname.endsWith(".nexmo.com"))throw new Error("Untrusted media URL");let u=await(await fetch(t)).arrayBuffer(),m=Buffer.from(u);return await M.writeFile(`/home/ubuntu/guido/media/${e}.${r}`,m),m.toString("base64")}catch(s){throw n.withScope(o=>{o.setTag("operation","getMedia"),o.setContext("payload",{mediaURL:t,messageID:e,extension:r}),n.captureException(s)}),s.userMessage="\u274C Media processing error",s}}async function f(t){if(t.from!==process.env.PHONE_NUMBER)return n.logger.warn("Unauthorized phone number",{phoneNumber:t.from}),{validation:"\u26A0\uFE0F Unauthorized"};let e={id:t.message_uuid,timestamp:new Date(t.timestamp),type:t.message_type};return e.type==="text"?(e.content=b(t.text),e.validation="OK"):e.type==="audio"||e.type==="image"||e.type==="file"?(e.content=await _(t[e.type].url,e.id,t[e.type].name.split(".")[1]),e.validation="OK"):e.validation="\u26A0\uFE0F Message type not supported",e}var P=new T({apiKey:process.env.VONAGE_API_KEY,apiSecret:process.env.VONAGE_API_SECRET,privateKey:""},{apiHost:"https://messages-sandbox.nexmo.com"});function d(t){try{P.messages.send({from:"14157386102",to:process.env.PHONE_NUMBER,channel:x.WHATSAPP,messageType:"text",text:t})}catch(e){throw n.withScope(r=>{r.setTag("operation","sendMessage"),r.setContext("payload",{messageText:t}),n.captureException(e)}),e.userMessage="\u274C Message sending error",e}}import{MongoClient as k,ServerApiVersion as H}from"mongodb";import*as p from"@sentry/node";var A={minPoolSize:1,maxPoolSize:2,maxIdleTimeMS:6e4,serverApi:{version:H.v1,strict:!0,deprecationErrors:!0}},i=null,l=null;try{if(!i){let t=new k(process.env.MONGODB_URI,A);await t.connect(),await t.db("admin").command({ping:1}),i=t}l=i.db(process.env.ENV).collection("tasks"),console.log("Database connection established")}catch(t){throw console.error("Failed to established database connection"),t}async function O(){if(i)try{await i.close(),i=null,console.log(`
Database connection shut down`)}catch(t){throw console.error(`
Failed to shut down database connection`),t}}process.on("SIGINT",async()=>{try{await O(),process.exit(0)}catch{process.exit(1)}});function N(t){return t.map(e=>({role:e.role,parts:[{text:e.content}]}))}function R(t,e){let r={whatsapp_id:t.id,timestamp:t.timestamp,type:t.type,role:"user",content:t.content},s={timestamp:e,role:"model",content:t.response};return[r,s]}async function g(t){try{let e=await l.findOne({status:"in_progress"},{projection:{messages:1,_id:1}});if(e)return{taskHistory:N(e.messages),taskID:e._id};{let r=await l.insertOne({started:t,updated:t,status:"in_progress",messages:[]});return{taskHistory:[],taskID:r.insertedId}}}catch(e){throw p.withScope(r=>{r.setTag("operation","getTaskHistory"),p.captureException(e)}),e.userMessage="\u274C Database error",e}}async function w(t,e,r=new Date){let s=R(t,r);try{let o={$push:{messages:{$each:s}},$set:{updated:r,...t.status&&{status:t.status}}};await l.updateOne({_id:e},o)}catch(o){throw p.withScope(u=>{u.setTag("operation","updateTaskHistory"),u.setContext("payload",{taskID:e,message:t}),p.captureException(o)}),o.userMessage="\u274C Database error",o}}import*as c from"@sentry/node";var a=h();a.use(h.json({limit:"1mb"}));a.use(D());a.post(process.env.APP_PATH,async(t,e)=>{try{y(t),e.status(200).end();let r=await f(t.body);if(r.validation!=="OK"){d(r.validation);return}let{taskHistory:s,taskID:o}=await g(r.timestamp);r.taskHistory=s,r.response="Bla bla",d(r.response),await w(r,o)}catch(r){e.headersSent||e.status(200).end(),r.userMessage||(c.withScope(s=>{s.setTag("operation","unknown"),c.captureException(r)}),r.userMessage="\u274C Unknown error"),d(r.userMessage)}});a.post(`${process.env.APP_PATH}/message-status`,async(t,e)=>{e.status(200).end()});a.get(process.env.APP_PATH,(t,e)=>{e.status(200).send("GuiDo is up and running! (commit: <b>"+process.env.CURRENT_COMMIT+"</b>)")});c.setupExpressErrorHandler(a);a.listen(process.env.EXPRESS_PORT,()=>{console.log("GuiDo running on port",process.env.EXPRESS_PORT),process.send&&process.send("ready")});
//# sourceMappingURL=app.js.map

//# debugId=c6c04eac-69ac-546e-854e-70c435e24b79
